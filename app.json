[{"name":"app.R","content":"##############################################\n# M450 Data Analysis Tool - IU / Shinylive\n##############################################\n\nlibrary(shiny)\nlibrary(DT)\nlibrary(broom)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(bslib)\nlibrary(munsell)\nlibrary(colorspace)\nlibrary(ggplot2)\nlibrary(rlang)\n\n# ==============================================================================\n# PERFORMANCE OPTIONS\n# ==============================================================================\noptions(shiny.maxRequestSize = 25 * 1024^2)  # 25 MB upload limit\noptions(shiny.autoreload = FALSE)             # Disable dev auto-reload\n\n# ==============================================================================\n# HELPER FUNCTIONS\n# ==============================================================================\n\n# Custom Skewness function\nskewness <- function(x, na.rm = FALSE) {\n  if (na.rm) x <- x[!is.na(x)]\n  n <- length(x)\n  if (n < 3) return(NA)\n  x <- x - mean(x)\n  y <- sqrt(mean(x^2))\n  sum(x^3) / (n * y^3)\n}\n\n# Custom Kurtosis function\nkurtosis <- function(x, na.rm = FALSE) {\n  if (na.rm) x <- x[!is.na(x)]\n  n <- length(x)\n  if (n < 4) return(NA)\n  x <- x - mean(x)\n  y <- mean(x^2)\n  (sum(x^4) / (n * y^2)) - 3\n}\n\n# DT Options Helper (updated: length menu + export-all buttons; default DOM includes 'l')\nget_dt_options <- function(scrollX = TRUE, dom = \"lBfrtip\", pageLength = 5) {\n  list(\n    scrollX = scrollX,\n    dom = dom,\n    pageLength = pageLength,\n    lengthMenu = list(\n      c(5, 10, 15, 25, 50, -1),\n      c(\"5\", \"10\", \"15\", \"25\", \"50\", \"All\")\n    ),\n    buttons = list(\n      list(\n        extend = \"copy\",\n        text = \"Copy\",\n        exportOptions = list(modifier = list(page = \"all\"))\n      ),\n      list(\n        extend = \"csv\",\n        text = \"CSV\",\n        exportOptions = list(modifier = list(page = \"all\"))\n      )\n    )\n  )\n}\n\n# ==============================================================================\n# MODULE: DATA FILTERING\n# ==============================================================================\n\nfilter_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Filter Data\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"filter_var_selector\")),\n        selectInput(ns(\"filter_op\"), \"Operator\",\n                    choices = c(\"Equals (==)\" = \"==\",\n                                \"Not Equals (!=)\" = \"!=\",\n                                \"Greater Than (>)\" = \">\",\n                                \"Less Than (<)\" = \"<\",\n                                \"Greater/Equal (>=)\" = \">=\",\n                                \"Less/Equal (<=)\" = \"<=\")),\n        textInput(ns(\"filter_val\"), \"Value (Enter number or text)\"),\n        actionButton(ns(\"apply_filter\"), \"Apply Filter\", class = \"btn-danger w-100\"),\n        hr(),\n        actionButton(ns(\"reset_data\"), \"Reset to Original Data\", class = \"btn-secondary w-100\")\n      ),\n      h5(\"Current Data Preview (First 10 Rows)\"),\n      p(class=\"text-muted\", \"Note: Filtering modifies the dataset used in all modules.\"),\n      DTOutput(ns(\"filter_preview\"))\n    )\n  )\n}\n\nfilter_server <- function(id, data_reactive, original_data_reactive, update_data_function) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n\n    output$filter_var_selector <- renderUI({\n      req(data_reactive())\n      selectInput(ns(\"filter_var\"), \"Select Variable to Filter\", choices = names(data_reactive()))\n    })\n\n    output$filter_preview <- renderDT({\n      req(data_reactive())\n      datatable(head(data_reactive(), 10),\n                options = list(scrollX = TRUE, dom = \"t\", pageLength = 10))\n    }, server = FALSE)\n\n    # APPLY FILTER\n    observeEvent(input$apply_filter, {\n      req(data_reactive(), input$filter_var, input$filter_op, input$filter_val)\n      df <- data_reactive()\n      var <- input$filter_var\n      op <- input$filter_op\n      val <- input$filter_val\n\n      tryCatch({\n        if (is.numeric(df[[var]])) {\n          val_numeric <- as.numeric(val)\n          if (is.na(val_numeric)) stop(\"Please enter a numeric value for this variable.\")\n          expr <- paste0(\"`\", var, \"` \", op, \" \", val_numeric)\n        } else {\n          if (op %in% c(\">\", \"<\", \">=\", \"<=\")) stop(\"Cannot use inequalities on text data.\")\n          expr <- paste0(\"`\", var, \"` \", op, \" '\", val, \"'\")\n        }\n\n        filtered_df <- df %>% dplyr::filter(eval(parse(text = expr)))\n\n        if (nrow(filtered_df) == 0) {\n          showNotification(\"Filter resulted in 0 rows! Operation cancelled.\", type = \"warning\")\n        } else {\n          update_data_function(filtered_df)\n          showNotification(paste(\"Filter applied. Remaining rows:\", nrow(filtered_df)), type = \"message\")\n        }\n      }, error = function(e) {\n        showNotification(paste(\"Filter Error:\", e$message), type = \"error\")\n      })\n    })\n\n    # RESET DATA\n    observeEvent(input$reset_data, {\n      req(original_data_reactive())\n      update_data_function(original_data_reactive())\n      showNotification(\"Data reset to original uploaded file.\", type = \"message\")\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: DATA TRANSFORMATION\n# ==============================================================================\n\ntransform_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Data Transformation\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"var_selector\")),\n        selectInput(ns(\"method\"), \"Transformation Method\",\n                    choices = c(\"Log (ln)\" = \"log\",\n                                \"Square Root\" = \"sqrt\",\n                                \"Square (x^2)\" = \"square\",\n                                \"Standardize (Z-score)\" = \"scale\",\n                                \"Convert to Factor\" = \"factor\",\n                                \"Change Base Level (Relevel)\" = \"relevel\",\n                                \"Create Interaction (*)\" = \"interaction\")),\n\n        uiOutput(ns(\"var2_selector\")),\n        uiOutput(ns(\"level_selector\")),\n\n        actionButton(ns(\"apply\"), \"Apply Transformation\", class = \"btn-warning w-100\")\n      ),\n      h5(\"Data Preview (First 10 Rows)\"),\n      DTOutput(ns(\"preview_table\"))\n    )\n  )\n}\n\ntransform_server <- function(id, data_reactive, update_data_function) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n\n    output$var_selector <- renderUI({\n      req(data_reactive())\n      selectInput(ns(\"var\"), \"Select Variable\", choices = names(data_reactive()))\n    })\n\n    output$var2_selector <- renderUI({\n      req(input$method)\n      if (input$method == \"interaction\") {\n        req(data_reactive())\n        selectInput(ns(\"var2\"), \"Select Second Variable (Interaction)\", choices = names(data_reactive()))\n      } else {\n        NULL\n      }\n    })\n\n    output$level_selector <- renderUI({\n      req(input$method, input$var, data_reactive())\n      if (input$method == \"relevel\") {\n        df <- data_reactive()\n        col <- input$var\n\n        if (is.factor(df[[col]])) {\n          lvls <- levels(df[[col]])\n        } else {\n          lvls <- sort(unique(df[[col]]))\n        }\n\n        selectInput(ns(\"ref_level\"), \"Select New Reference Level\", choices = lvls)\n      } else {\n        NULL\n      }\n    })\n\n    output$preview_table <- renderDT({\n      req(data_reactive())\n      datatable(head(data_reactive(), 10),\n                options = list(scrollX = TRUE, dom = \"t\", pageLength = 10))\n    }, server = FALSE)\n\n    observeEvent(input$apply, {\n      req(data_reactive(), input$var)\n      df <- data_reactive()\n      col <- input$var\n      method <- input$method\n\n      tryCatch({\n        if (method == \"interaction\") {\n          req(input$var2)\n          col2 <- input$var2\n          if (!is.numeric(df[[col]]) || !is.numeric(df[[col2]]))\n            stop(\"Interaction requires both variables to be numeric.\")\n\n          new_col_name <- paste0(col, \"_x_\", col2)\n          df[[new_col_name]] <- df[[col]] * df[[col2]]\n          showNotification(paste(\"Created variable:\", new_col_name), type = \"message\")\n\n        } else if (method == \"relevel\") {\n          req(input$ref_level)\n\n          if (!is.factor(df[[col]])) {\n            df[[col]] <- as.factor(df[[col]])\n          }\n\n          df[[col]] <- relevel(df[[col]], ref = input$ref_level)\n          showNotification(paste(\"Variable\", col, \"releveled. Base case:\", input$ref_level), type = \"message\")\n\n        } else {\n          new_col_name <- paste0(col, \"_\", method)\n\n          if (method == \"log\") {\n            if (!is.numeric(df[[col]])) stop(\"Log requires numeric data.\")\n            df[[new_col_name]] <- log(df[[col]] + 1e-6)\n          } else if (method == \"sqrt\") {\n            if (!is.numeric(df[[col]])) stop(\"Sqrt requires numeric data.\")\n            df[[new_col_name]] <- sqrt(df[[col]])\n          } else if (method == \"square\") {\n            if (!is.numeric(df[[col]])) stop(\"Square requires numeric data.\")\n            df[[new_col_name]] <- df[[col]]^2\n          } else if (method == \"scale\") {\n            if (!is.numeric(df[[col]])) stop(\"Scale requires numeric data.\")\n            df[[new_col_name]] <- as.vector(scale(df[[col]]))\n          } else if (method == \"factor\") {\n            df[[col]] <- as.factor(df[[col]])\n            showNotification(paste(\"Converted\", col, \"to factor.\"), type = \"message\")\n            update_data_function(df)\n            return()\n          }\n\n          showNotification(paste(\"Created variable:\", new_col_name), type = \"message\")\n        }\n\n        update_data_function(df)\n\n      }, error = function(e) {\n        showNotification(paste(\"Error:\", e$message), type = \"error\")\n      })\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: SUMMARY STATS & DISTRIBUTIONS\n# ==============================================================================\n\nsummary_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Summary Statistics & Distributions\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"var_selector\")),\n        uiOutput(ns(\"group_selector\")),\n        checkboxGroupInput(ns(\"stats\"), \"Numeric Stats\",\n                           choices = c(\"N\", \"Mean\", \"SD\", \"Min\", \"Max\",\n                                       \"Median\", \"Skewness\", \"Kurtosis\"),\n                           selected = c(\"N\", \"Mean\", \"SD\", \"Min\", \"Max\"))\n      ),\n      card(\n        card_header(\"Output\"),\n        uiOutput(ns(\"dynamic_content\"))\n      )\n    )\n  )\n}\n\nsummary_server <- function(id, data_reactive) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n\n    output$var_selector <- renderUI({\n      req(data_reactive())\n      selectizeInput(ns(\"vars\"), \"Select Variables\",\n                     choices = names(data_reactive()), multiple = TRUE)\n    })\n\n    output$group_selector <- renderUI({\n      req(data_reactive())\n      selectizeInput(ns(\"group_var\"), \"Group By (Optional)\",\n                     choices = c(\"None\" = \"\", names(data_reactive())),\n                     multiple = FALSE)\n    })\n\n    output$dynamic_content <- renderUI({\n      req(data_reactive(), input$vars)\n      df <- data_reactive()\n      selected_vars <- input$vars\n\n      num_vars <- names(df)[sapply(df, is.numeric)]\n      selected_num <- intersect(selected_vars, num_vars)\n      selected_cat <- setdiff(selected_vars, num_vars)\n\n      ui_list <- list()\n\n      if (length(selected_num) > 0) {\n        ui_list[[length(ui_list) + 1]] <- h5(\"Numeric Summary Statistics\")\n        ui_list[[length(ui_list) + 1]] <- DTOutput(ns(\"stats_table\"))\n      }\n\n      if (length(selected_cat) > 0) {\n        if (length(ui_list) > 0) ui_list[[length(ui_list) + 1]] <- hr()\n        ui_list[[length(ui_list) + 1]] <- h5(\"Categorical Distributions\")\n        for (v in selected_cat) {\n          ui_list[[length(ui_list) + 1]] <- h6(paste(\"Distribution:\", v))\n          ui_list[[length(ui_list) + 1]] <- plotOutput(ns(paste0(\"plot_\", v)))\n          ui_list[[length(ui_list) + 1]] <- br()\n        }\n      }\n\n      tagList(ui_list)\n    })\n\n    output$stats_table <- renderDT({\n      req(data_reactive(), input$vars)\n      df <- data_reactive()\n      group_var <- input$group_var\n      if (is.null(group_var) || group_var == \"\") group_var <- NULL\n\n      num_vars <- names(df)[sapply(df, is.numeric)]\n      selected_num <- intersect(input$vars, num_vars)\n      if (length(selected_num) == 0) return(NULL)\n\n      if (!is.null(group_var)) {\n        df_long <- df %>%\n          select(all_of(c(group_var, selected_num))) %>%\n          pivot_longer(cols = all_of(selected_num),\n                       names_to = \"Variable\", values_to = \"Value\") %>%\n          group_by(across(all_of(c(group_var, \"Variable\"))))\n\n        res <- df_long %>%\n          summarise(\n            N = if (\"N\" %in% input$stats) sum(!is.na(Value)) else NULL,\n            Mean = if (\"Mean\" %in% input$stats) mean(Value, na.rm = TRUE) else NULL,\n            SD = if (\"SD\" %in% input$stats) sd(Value, na.rm = TRUE) else NULL,\n            Min = if (\"Min\" %in% input$stats) min(Value, na.rm = TRUE) else NULL,\n            Max = if (\"Max\" %in% input$stats) max(Value, na.rm = TRUE) else NULL,\n            Median = if (\"Median\" %in% input$stats) median(Value, na.rm = TRUE) else NULL,\n            Skewness = if (\"Skewness\" %in% input$stats) skewness(Value, na.rm = TRUE) else NULL,\n            Kurtosis = if (\"Kurtosis\" %in% input$stats) kurtosis(Value, na.rm = TRUE) else NULL,\n            .groups = \"drop\"\n          ) %>%\n          mutate(across(where(is.numeric), ~ round(., 3)))\n\n        datatable(res, extensions = \"Buttons\", options = get_dt_options(dom = \"lBfrtip\"))\n      } else {\n        df_long <- df %>%\n          select(all_of(selected_num)) %>%\n          pivot_longer(cols = everything(),\n                       names_to = \"Variable\", values_to = \"Value\") %>%\n          group_by(Variable)\n\n        res <- df_long %>%\n          summarise(\n            N = if (\"N\" %in% input$stats) sum(!is.na(Value)) else NULL,\n            Mean = if (\"Mean\" %in% input$stats) mean(Value, na.rm = TRUE) else NULL,\n            SD = if (\"SD\" %in% input$stats) sd(Value, na.rm = TRUE) else NULL,\n            Min = if (\"Min\" %in% input$stats) min(Value, na.rm = TRUE) else NULL,\n            Max = if (\"Max\" %in% input$stats) max(Value, na.rm = TRUE) else NULL,\n            Median = if (\"Median\" %in% input$stats) median(Value, na.rm = TRUE) else NULL,\n            Skewness = if (\"Skewness\" %in% input$stats) skewness(Value, na.rm = TRUE) else NULL,\n            Kurtosis = if (\"Kurtosis\" %in% input$stats) kurtosis(Value, na.rm = TRUE) else NULL\n          ) %>%\n          mutate(across(where(is.numeric), ~ round(., 3)))\n\n        datatable(res, extensions = \"Buttons\", options = get_dt_options(dom = \"lBfrtip\"))\n      }\n    }, server = FALSE)\n\n    # Categorical plots\n    observe({\n      req(data_reactive(), input$vars)\n      df <- data_reactive()\n      cat_vars <- names(df)[!sapply(df, is.numeric)]\n      selected_cat <- intersect(input$vars, cat_vars)\n      group_var <- input$group_var\n      if (!is.null(group_var) && group_var == \"\") group_var <- NULL\n\n      for (v in selected_cat) {\n        local({\n          my_v <- v\n          output[[paste0(\"plot_\", my_v)]] <- renderPlot({\n            p <- ggplot(df, aes_string(x = paste0(\"`\", my_v, \"`\")))\n\n            if (!is.null(group_var)) {\n              p <- p +\n                geom_bar(aes_string(fill = paste0(\"`\", group_var, \"`\")),\n                         position = \"dodge\", color = \"black\") +\n                geom_text(stat = \"count\",\n                          aes(label = ..count..,\n                              group = !!sym(group_var)),\n                          position = position_dodge(width = 0.9),\n                          vjust = -0.5) +\n                labs(fill = group_var)\n            } else {\n              p <- p +\n                geom_bar(fill = \"#990000\", color = \"black\") +\n                geom_text(stat = \"count\", aes(label = ..count..), vjust = -0.5)\n            }\n\n            p +\n              theme_minimal() +\n              labs(y = \"Count\", title = NULL) +\n              theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n              scale_y_continuous(expand = expansion(mult = c(0, 0.15)))\n          })\n        })\n      }\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: CORRELATION (NUMERIC TABLE)\n# ==============================================================================\n\ncorr_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Correlation Analysis (Numeric Table)\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"num_var_selector\")),\n        actionButton(ns(\"run_corr\"), \"Calculate Correlations\", class = \"btn-primary w-100\")\n      ),\n      DTOutput(ns(\"corr_table\"))\n    )\n  )\n}\n\ncorr_server <- function(id, data_reactive) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n\n    output$num_var_selector <- renderUI({\n      req(data_reactive())\n      num_vars <- names(data_reactive())[sapply(data_reactive(), is.numeric)]\n      selectizeInput(ns(\"vars\"), \"Select Numeric Variables\",\n                     choices = num_vars, multiple = TRUE, selected = NULL)\n    })\n\n    observeEvent(input$run_corr, {\n      req(data_reactive(), input$vars)\n      df_num <- data_reactive()[, input$vars, drop = FALSE]\n\n      M <- cor(df_num, use = \"complete.obs\")\n      M_rounded <- round(M, 3)\n\n      output$corr_table <- renderDT({\n        datatable(M_rounded, extensions = \"Buttons\",\n                  options = get_dt_options(dom = \"lBfrtip\")) %>%\n          formatStyle(columns = colnames(M_rounded),\n                      backgroundColor = styleInterval(\n                        c(-0.5, 0.5),\n                        c(\"#f8d7da\", \"#ffffff\", \"#d4edda\")\n                      ))\n      }, server = FALSE)\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: CLUSTER ANALYSIS (K-MEANS, NO factoextra/cluster PACKAGE)\n# ==============================================================================\n\ncluster_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Cluster Analysis (K-Means)\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"col_selector\")),\n        actionButton(ns(\"run_diagnostics\"), \"Generate Diagnostics (Elbow/Dendrogram)\",\n                     class = \"btn-info w-100 mb-3\", icon = icon(\"chart-area\")),\n        hr(),\n        numericInput(ns(\"k\"), \"Number of Clusters (k)\", value = 2, min = 1),\n        actionButton(ns(\"run_cluster\"), \"Run Clustering & Save\",\n                     class = \"btn-success w-100\", icon = icon(\"save\")),\n        p(class=\"text-muted small mt-2\",\n          \"Note: 'Run Clustering' will add a 'Cluster_Membership' variable to your dataset.\")\n      ),\n      navset_card_tab(\n        nav_panel(\"Elbow Plot\", plotOutput(ns(\"elbow_plot\"))),\n        nav_panel(\"Dendrogram\", plotOutput(ns(\"dendrogram\"))),\n        nav_panel(\"Cluster Summary\", DTOutput(ns(\"cluster_summary\")))\n      )\n    )\n  )\n}\n\ncluster_server <- function(id, data_reactive, update_data_function) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n\n    output$col_selector <- renderUI({\n      req(data_reactive())\n      num_vars <- names(data_reactive())[sapply(data_reactive(), is.numeric)]\n      checkboxGroupInput(ns(\"cols\"), \"Select Variables for Clustering\",\n                         choices = num_vars, selected = NULL)\n    })\n\n    clean_data <- reactive({\n      req(data_reactive(), input$cols)\n      data_reactive()[, input$cols, drop = FALSE] %>% na.omit()\n    })\n\n    scaled_data <- reactive({\n      req(clean_data())\n      scale(clean_data())\n    })\n\n    observeEvent(input$run_diagnostics, {\n      req(scaled_data())\n\n      output$elbow_plot <- renderPlot({\n        data_for_k <- scaled_data()\n        max_k <- min(8, nrow(data_for_k) - 1)\n        if (max_k < 2) {\n          plot.new()\n          title(\"Not enough rows for elbow plot\")\n        } else {\n          wss <- sapply(1:max_k, function(k) {\n            kmeans(data_for_k, centers = k, nstart = 5)$tot.withinss\n          })\n          plot(\n            1:max_k, wss, type = \"b\",\n            xlab = \"Number of clusters (k)\",\n            ylab = \"Total within-cluster sum of squares\",\n            main = \"Elbow Method for Choosing k\"\n          )\n        }\n      })\n\n      output$dendrogram <- renderPlot({\n        data_for_tree <- scaled_data()\n\n        # Limit dendrogram computation to prevent memory issues\n        max_rows <- min(50, nrow(data_for_tree))\n\n        if (nrow(data_for_tree) > max_rows) {\n          set.seed(42)\n          data_for_tree <- data_for_tree[sample(1:nrow(data_for_tree), max_rows), ]\n        }\n\n        # Skip dendrogram if still too large\n        if (nrow(data_for_tree) < 2) {\n          plot.new()\n          title(\"Not enough data for dendrogram\")\n          return()\n        }\n\n        dist_matrix <- dist(data_for_tree)\n        hc <- hclust(dist_matrix, method = \"ward.D2\")\n        plot(hc, main = paste0(\"Dendrogram (Sample of \", nrow(data_for_tree), \" rows)\"), xlab = \"\", sub = \"\")\n      })\n\n      output$cluster_summary <- renderDT(NULL)\n    })\n\n    observeEvent(input$run_cluster, {\n      req(clean_data(), input$k)\n\n      # Limit k-means to reasonable cluster count\n      if (input$k > 10) {\n        showNotification(\"Maximum 10 clusters allowed for stability.\", type = \"warning\")\n        return()\n      }\n\n      # Reduce nstart for large datasets to save computation\n      nstart_val <- if (nrow(clean_data()) > 500) 3 else 5\n\n      set.seed(42)\n      k_res <- kmeans(clean_data(), centers = input$k, nstart = nstart_val)\n\n      current_df <- data_reactive()\n\n      base_name <- \"Cluster_Membership\"\n      new_name <- base_name\n      counter <- 1\n\n      while (new_name %in% names(current_df)) {\n        counter <- counter + 1\n        new_name <- paste0(base_name, \"_\", counter)\n      }\n\n      cluster_vec <- rep(NA, nrow(current_df))\n      used_indices <- which(complete.cases(current_df[, input$cols, drop = FALSE]))\n      cluster_vec[used_indices] <- as.factor(k_res$cluster)\n\n      current_df[[new_name]] <- as.factor(cluster_vec)\n\n      update_data_function(current_df)\n      showNotification(paste(\"Clustering complete! Added variable:\", new_name), type = \"message\")\n\n      segment_means <- round(k_res$centers, 2)\n      colnames(segment_means) <- paste0(\"Mean_\", colnames(segment_means))\n\n      summary_df <- data.frame(\n        Cluster = 1:input$k,\n        Count = k_res$size,\n        Percentage = round((k_res$size / sum(k_res$size)) * 100, 2),\n        segment_means\n      )\n\n      output$cluster_summary <- renderDT({\n        datatable(summary_df, extensions = \"Buttons\", options = get_dt_options(dom = \"lBfrtip\"))\n      }, server = FALSE)\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: REGRESSION (LINEAR)\n# ==============================================================================\n\nlinear_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Linear Regression\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"dep_selector\")),\n        uiOutput(ns(\"indep_selector\")),\n        actionButton(ns(\"run\"), \"Run Model\", class = \"btn-primary w-100\")\n      ),\n      navset_card_tab(\n        nav_panel(\"Output\", DTOutput(ns(\"model_table\"))),\n        nav_panel(\"Stats\", verbatimTextOutput(ns(\"model_stats\")))\n      )\n    )\n  )\n}\n\nlinear_server <- function(id, data_reactive, shared_model) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n    res_store <- reactiveVal()\n\n    output$dep_selector <- renderUI({\n      req(data_reactive())\n      selectInput(ns(\"dep\"), \"Dependent Variable\", choices = names(data_reactive()))\n    })\n\n    output$indep_selector <- renderUI({\n      req(data_reactive())\n      selectizeInput(ns(\"indep\"), \"Independent Variables\",\n                     choices = names(data_reactive()), multiple = TRUE)\n    })\n\n    observeEvent(input$run, {\n      req(data_reactive(), input$dep, input$indep)\n      df <- data_reactive()\n      f <- as.formula(paste0(\"`\", input$dep, \"` ~ \",\n                             paste(paste0(\"`\", input$indep, \"`\"), collapse = \"+\")))\n      m <- lm(f, data = df)\n\n      res_table <- tidy(m) %>% mutate(across(where(is.numeric), ~ round(., 3)))\n      res_store(res_table)\n\n      # Store model in shared reactive for prediction tool\n      shared_model(list(\n        model = m,\n        dep = input$dep,\n        indep = input$indep,\n        type = \"linear\"\n      ))\n\n      output$model_table <- renderDT({\n        datatable(res_table, extensions = \"Buttons\",\n                  options = get_dt_options(dom = \"lBfrtip\"))\n      }, server = FALSE)\n      output$model_stats <- renderPrint({ summary(m) })\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: REGRESSION (LOGISTIC)\n# ==============================================================================\n\nlogistic_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Logistic Regression\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"dep_selector\")),\n        uiOutput(ns(\"indep_selector\")),\n        actionButton(ns(\"run\"), \"Run Model\", class = \"btn-primary w-100\")\n      ),\n      navset_card_tab(\n        nav_panel(\"Output\", DTOutput(ns(\"model_table\"))),\n        nav_panel(\"Confusion Matrix\", verbatimTextOutput(ns(\"conf_matrix\")))\n      )\n    )\n  )\n}\n\nlogistic_server <- function(id, data_reactive, shared_model) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n    res_store <- reactiveVal()\n\n    output$dep_selector <- renderUI({\n      req(data_reactive())\n      selectInput(ns(\"dep\"), \"Dependent (Binary)\", choices = names(data_reactive()))\n    })\n\n    output$indep_selector <- renderUI({\n      req(data_reactive())\n      selectizeInput(ns(\"indep\"), \"Independent Variables\",\n                     choices = names(data_reactive()), multiple = TRUE)\n    })\n\n    observeEvent(input$run, {\n      req(data_reactive(), input$dep, input$indep)\n      df <- data_reactive()\n      f <- as.formula(paste0(\"`\", input$dep, \"` ~ \",\n                             paste(paste0(\"`\", input$indep, \"`\"), collapse = \"+\")))\n      m <- glm(f, data = df, family = \"binomial\")\n\n      res_table <- tidy(m) %>% mutate(across(where(is.numeric), ~ round(., 3)))\n      res_store(res_table)\n\n      # Store model in shared reactive for prediction tool\n      shared_model(list(\n        model = m,\n        dep = input$dep,\n        indep = input$indep,\n        type = \"logistic\"\n      ))\n\n      output$model_table <- renderDT({\n        datatable(res_table, extensions = \"Buttons\",\n                  options = get_dt_options(dom = \"lBfrtip\"))\n      }, server = FALSE)\n\n      output$conf_matrix <- renderPrint({\n        preds <- ifelse(predict(m, type = \"response\") > 0.5, 1, 0)\n        actual <- df[[input$dep]]\n        table(Predicted = preds, Actual = actual)\n      })\n    })\n  })\n}\n\n# ==============================================================================\n# MODULE: PREDICTION TOOL\n# ==============================================================================\n\npredict_ui <- function(id) {\n  ns <- NS(id)\n  card(\n    card_header(\"Prediction Tool\"),\n    layout_sidebar(\n      sidebar = sidebar(\n        uiOutput(ns(\"model_status\")),\n        hr(),\n        h5(\"Enter Values for Prediction\"),\n        uiOutput(ns(\"predictor_inputs\")),\n        actionButton(ns(\"predict\"), \"Generate Prediction\", class = \"btn-success w-100 mt-3\")\n      ),\n      h5(\"Model Coefficients\"),\n      DTOutput(ns(\"model_table\")),\n      hr(),\n      h5(\"Prediction Output\"),\n      uiOutput(ns(\"prediction_output\"))\n    )\n  )\n}\n\npredict_server <- function(id, data_reactive, shared_model) {\n  moduleServer(id, function(input, output, session) {\n    ns <- session$ns\n\n    # Display current model status\n    output$model_status <- renderUI({\n      model_info <- shared_model()\n\n      if (is.null(model_info)) {\n        div(class = \"alert alert-warning\",\n            icon(\"exclamation-triangle\"),\n            strong(\" No model loaded\"),\n            p(\"Please run a Linear or Logistic Regression first, then return here to make predictions.\")\n        )\n      } else {\n        model_type_label <- ifelse(model_info$type == \"linear\", \"Linear Regression\", \"Logistic Regression\")\n        div(class = \"alert alert-success\",\n            icon(\"check-circle\"),\n            strong(paste(\" Model Loaded:\", model_type_label)),\n            p(strong(\"Dependent: \"), model_info$dep),\n            p(strong(\"Independent: \"), paste(model_info$indep, collapse = \", \"))\n        )\n      }\n    })\n\n    # Show model coefficients as a table\n    output$model_table <- renderDT({\n      req(shared_model())\n      m <- shared_model()$model\n      res_table <- tidy(m) %>% mutate(across(where(is.numeric), ~ round(., 4)))\n      datatable(res_table, extensions = \"Buttons\",\n                options = get_dt_options(dom = \"lBfrtip\"))\n    }, server = FALSE)\n\n    # Generate predictor input fields\n    output$predictor_inputs <- renderUI({\n      req(shared_model())\n      vars <- shared_model()$indep\n      df <- data_reactive()\n\n      input_list <- lapply(vars, function(v) {\n        if (is.numeric(df[[v]])) {\n          numericInput(ns(paste0(\"pred_\", v)),\n                       label = v,\n                       value = round(mean(df[[v]], na.rm = TRUE), 2))\n        } else {\n          # For categorical variables, show dropdown with levels\n          levels_v <- if (is.factor(df[[v]])) levels(df[[v]]) else unique(df[[v]])\n          selectInput(ns(paste0(\"pred_\", v)),\n                      label = v,\n                      choices = levels_v)\n        }\n      })\n\n      tagList(input_list)\n    })\n\n    # Single prediction\n    observeEvent(input$predict, {\n      req(shared_model())\n\n      model_info <- shared_model()\n      m <- model_info$model\n      vars <- model_info\n      df <- data_reactive()\n\n      tryCatch({\n        # Build new data frame for prediction\n        new_data <- data.frame(row.names = 1)\n\n        for (v in vars$indep) {\n          input_val <- input[[paste0(\"pred_\", v)]]\n          if (is.numeric(df[[v]])) {\n            new_data[[v]] <- as.numeric(input_val)\n          } else {\n            new_data[[v]] <- input_val\n            if (is.factor(df[[v]])) {\n              new_data[[v]] <- factor(new_data[[v]], levels = levels(df[[v]]))\n            }\n          }\n        }\n\n        # Make prediction\n        if (vars$type == \"linear\") {\n          pred <- predict(m, newdata = new_data, interval = \"confidence\")\n\n          output$prediction_output <- renderUI({\n            tagList(\n              div(class = \"alert alert-success\",\n                  h4(\"Predicted Value\"),\n                  p(strong(paste0(vars$dep, \" = \", round(pred[1, \"fit\"], 4)))),\n                  p(paste0(\"95% Confidence Interval: [\",\n                           round(pred[1, \"lwr\"], 4), \", \",\n                           round(pred[1, \"upr\"], 4), \"]\"))\n              ),\n              h6(\"Input Values Used:\"),\n              tags$ul(\n                lapply(vars$indep, function(v) {\n                  tags$li(paste0(v, \" = \", input[[paste0(\"pred_\", v)]]))\n                })\n              )\n            )\n          })\n\n        } else {\n          # Logistic regression\n          pred_prob <- predict(m, newdata = new_data, type = \"response\")\n          pred_class <- ifelse(pred_prob > 0.5, 1, 0)\n\n          output$prediction_output <- renderUI({\n            tagList(\n              div(class = \"alert alert-info\",\n                  h4(\"Predicted Probability\"),\n                  p(strong(paste0(\"P(\", vars$dep, \" = 1) = \", round(pred_prob, 4)))),\n                  p(paste0(\"Predicted Class (threshold = 0.5): \", pred_class))\n              ),\n              h6(\"Input Values Used:\"),\n              tags$ul(\n                lapply(vars$indep, function(v) {\n                  tags$li(paste0(v, \" = \", input[[paste0(\"pred_\", v)]]))\n                })\n              )\n            )\n          })\n        }\n\n      }, error = function(e) {\n        showNotification(paste(\"Prediction error:\", e$message), type = \"error\")\n      })\n    })\n  })\n}\n\n# ==============================================================================\n# IU BRANDING CSS & JS\n# ==============================================================================\n\niu_theme_css <- \"\n:root {\n  --iu-crimson: #990000;\n  --iu-cream:   #EDE6D6;\n  --iu-grey:    #7D7D7D;\n  --iu-black:   #000000;\n  --iu-white:   #FFFFFF;\n}\n\n/* NAVBAR / HEADER */\n.navbar {\n  background-color: var(--iu-crimson) !important;\n  border-bottom: 3px solid var(--iu-cream);\n}\n\n.navbar .navbar-brand,\n.navbar span,\n.navbar a {\n  color: var(--iu-white) !important;\n  font-weight: bold;\n  font-size: 1.1rem;\n}\n\n/* SIDEBAR */\n.bslib-sidebar {\n  background-color: var(--iu-cream) !important;\n  padding-top: 1rem;\n  border-right: 3px solid var(--iu-crimson);\n}\n\n.bslib-sidebar ul {\n  padding-left: 0 !important;\n}\n\n.bslib-sidebar a {\n  display: block;\n  padding: 10px 16px;\n  margin-bottom: 6px;\n  border-radius: 6px;\n  font-weight: 600;\n  color: var(--iu-black) !important;\n  text-decoration: none !important;\n  background-color: transparent;\n  transition: all 0.2s ease-in-out;\n}\n\n.bslib-sidebar a i {\n  margin-right: 8px;\n  color: var(--iu-crimson);\n}\n\n/* Hover */\n.bslib-sidebar a:hover {\n  background-color: var(--iu-crimson);\n  color: var(--iu-white) !important;\n}\n\n.bslib-sidebar a:hover i {\n  color: var(--iu-white);\n}\n\n/* Active item */\n.active-sidebar-item {\n  background-color: var(--iu-crimson) !important;\n  color: var(--iu-white) !important;\n}\n\n.active-sidebar-item i {\n  color: var(--iu-white) !important;\n}\n\n/* MOBILE SIDEBAR */\n@media (max-width: 992px) {\n  .bslib-sidebar {\n    position: fixed;\n    top: 56px;\n    left: -260px;\n    width: 240px;\n    height: 100%;\n    background-color: var(--iu-cream) !important;\n    box-shadow: 4px 0px 10px rgba(0,0,0,0.2);\n    transition: left 0.3s ease;\n    z-index: 1050;\n  }\n  .sidebar-open .bslib-sidebar {\n    left: 0;\n  }\n  .mobile-toggle {\n    position: relative;\n    margin-right: 12px;\n    background-color: var(--iu-white);\n    border: 2px solid var(--iu-crimson);\n    border-radius: 6px;\n    padding: 4px 8px;\n    cursor: pointer;\n    font-weight: bold;\n  }\n}\n\"\n\n# ==============================================================================\n# MAIN UI\n# ==============================================================================\n\nui <- page_sidebar(\n  title = div(\n    class = \"d-flex align-items-center\",\n    img(\n      src = \"https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/Indiana_Hoosiers_logo.svg/1280px-Indiana_Hoosiers_logo.svg.png\",\n      height = \"40px\",\n      style = \"margin-right: 15px; background-color: white; padding: 5px; border-radius: 5px;\"\n    ),\n    span(\"M450 Data Analysis Tool\",\n         style = \"font-weight: bold; font-size: 1.2rem; color: white;\")\n  ),\n\n  theme = bs_theme(\n    version = 5,\n    bg = \"#FFFFFF\",\n    fg = \"#000000\",\n    primary = \"#990000\",\n    secondary = \"#EDE6D6\",\n    base_font = \"Source Sans Pro, sans-serif\"\n  ),\n\n  tags$head(\n    tags$style(HTML(iu_theme_css)),\n    # Active link highlight\n    tags$script(HTML(\"\n      document.addEventListener('DOMContentLoaded', function() {\n        const sidebar = document.querySelector('.bslib-sidebar');\n        if (!sidebar) return;\n        const links = sidebar.querySelectorAll('a');\n        if (links.length > 0) {\n          links[0].classList.add('active-sidebar-item');\n        }\n        links.forEach(link => {\n          link.addEventListener('click', function() {\n            links.forEach(l => l.classList.remove('active-sidebar-item'));\n            this.classList.add('active-sidebar-item');\n          });\n        });\n      });\n    \")),\n    # Mobile toggle behavior\n    tags$script(HTML(\"\n      document.addEventListener('click', function(e) {\n        if (e.target.closest('.mobile-toggle')) {\n          document.body.classList.toggle('sidebar-open');\n        } else if (e.target.closest('.bslib-sidebar a')) {\n          document.body.classList.remove('sidebar-open');\n        }\n      });\n    \"))\n  ),\n\n  sidebar = sidebar(\n    title = \"Navigation\",\n    tags$ul(\n      class = \"list-unstyled\",\n      tags$li(actionLink(\"go_home\", \"Home / Upload\", icon = icon(\"home\"))),\n      tags$li(actionLink(\"go_filter\", \"Filter Data\", icon = icon(\"filter\"))),\n      tags$li(actionLink(\"go_summary\", \"Summary Stats\", icon = icon(\"chart-bar\"))),\n      tags$li(actionLink(\"go_corr\", \"Correlations\", icon = icon(\"th\"))),\n      tags$li(actionLink(\"go_transform\", \"Data Transformation\", icon = icon(\"magic\"))),\n      tags$li(actionLink(\"go_cluster\", \"Cluster Analysis\", icon = icon(\"object-group\"))),\n      tags$li(actionLink(\"go_linear\", \"Linear Regression\", icon = icon(\"chart-line\"))),\n      tags$li(actionLink(\"go_logistic\", \"Logistic Regression\", icon = icon(\"check-circle\"))),\n      tags$li(actionLink(\"go_predict\", \"Prediction Tool\", icon = icon(\"calculator\")))\n    )\n  ),\n\n  uiOutput(\"page_content\")\n)\n\n# ==============================================================================\n# SERVER\n# ==============================================================================\n\nserver <- function(input, output, session) {\n\n  original_data <- reactiveVal(NULL) # store original upload\n  shared_model  <- reactiveVal(NULL) # shared model for prediction tool\n  global_data   <- reactiveVal(NULL) # working copy\n\n  update_data <- function(new_df) {\n    global_data(new_df)\n  }\n\n  current_page <- reactiveVal(\"home\")\n\n  observeEvent(input$go_home,     { current_page(\"home\") })\n  observeEvent(input$go_filter,   { current_page(\"filter\") })\n  observeEvent(input$go_summary,  { current_page(\"summary\") })\n  observeEvent(input$go_corr,     { current_page(\"corr\") })\n  observeEvent(input$go_transform,{ current_page(\"transform\") })\n  observeEvent(input$go_cluster,  { current_page(\"cluster\") })\n  observeEvent(input$go_linear,   { current_page(\"linear\") })\n  observeEvent(input$go_logistic, { current_page(\"logistic\") })\n  observeEvent(input$go_predict,  { current_page(\"predict\") })\n\n  output$page_content <- renderUI({\n    page <- current_page()\n\n    if (page == \"home\") {\n      card(\n        card_header(\"Welcome to M450 Data Analytics\"),\n        p(\"Please upload a CSV dataset below. This data will be available across all modules.\"),\n        fileInput(\"upload_file\", \"Upload Dataset (CSV)\", accept = c(\".csv\")),\n        hr(),\n        h5(\"Current Data Preview:\"),\n        DTOutput(\"home_preview\")\n      )\n    } else if (page == \"filter\") {\n      filter_ui(\"mod_filter\")\n    } else if (page == \"summary\") {\n      summary_ui(\"mod_summary\")\n    } else if (page == \"corr\") {\n      corr_ui(\"mod_corr\")\n    } else if (page == \"transform\") {\n      transform_ui(\"mod_transform\")\n    } else if (page == \"cluster\") {\n      cluster_ui(\"mod_cluster\")\n    } else if (page == \"linear\") {\n      linear_ui(\"mod_linear\")\n    } else if (page == \"logistic\") {\n      logistic_ui(\"mod_logistic\")\n    } else if (page == \"predict\") {\n      predict_ui(\"mod_predict\")\n    }\n  })\n\n  # Upload handler (CSV only, Shinylive-safe)\n  observeEvent(input$upload_file, {\n    req(input$upload_file)\n\n    # File size limit: 25 MB\n    if (input$upload_file$size > 25 * 1024 * 1024) {\n      showNotification(\"File too large. Please upload a CSV file smaller than 25 MB.\", type = \"error\")\n      return()\n    }\n\n    tryCatch({\n      df <- read.csv(input$upload_file$datapath, check.names = FALSE)\n\n      # Row limit for stability\n      if (nrow(df) > 20000) {\n        showNotification(\"Dataset has more than 20,000 rows. Using first 20,000 rows only.\", type = \"warning\")\n        df <- df[1:20000, ]\n      }\n\n      original_data(df)\n      global_data(df)\n      showNotification(\"Data uploaded successfully!\", type = \"message\")\n    }, error = function(e) {\n      showNotification(paste(\"Error reading file:\", e$message), type = \"error\")\n    })\n  })\n\n  output$home_preview <- renderDT({\n    req(global_data())\n    datatable(head(global_data(), 10),\n              options = list(scrollX = TRUE, dom = \"t\", pageLength = 10))\n  }, server = FALSE)\n\n  # Module calls\n  filter_server(\"mod_filter\", global_data, original_data, update_data)\n  summary_server(\"mod_summary\", global_data)\n  corr_server(\"mod_corr\", global_data)\n  transform_server(\"mod_transform\", global_data, update_data)\n  cluster_server(\"mod_cluster\", global_data, update_data)\n  linear_server(\"mod_linear\", global_data, shared_model)\n  logistic_server(\"mod_logistic\", global_data, shared_model)\n  predict_server(\"mod_predict\", global_data, shared_model)\n}\n\nshinyApp(ui, server)\n","type":"text"},{"name":"README.md","content":"---\ntitle: M450 Data Analysis Tool (Shinylive)\nemoji: ðŸ”¬\ncolorFrom: red\ncolorTo: yellow\nsdk: static\napp_file: index.html\npinned: false\n---\n\n# M450 Data Analysis Tool (Shinylive Version)\n\nAn interactive data analysis tool built with R Shiny, running entirely in your browser via Shinylive (WebAssembly).\n\n## Features\n- Summary Statistics and Distributions\n- Correlation Analysis\n- Data Transformation\n- K-Means Clustering\n- Linear and Logistic Regression\n- Prediction Tool\n\n## Notes\n- No server required - runs 100% in your browser\n- First load takes 15-30 seconds while R packages initialize\n- Upload limit: 5 MB, 5000 rows\n- Built with R Shiny + Shinylive\n","type":"text"}]
